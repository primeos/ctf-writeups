# Day 17: Faster KEy Exchange

## Challenge text

```
You were somehow able to intercept Santa's traffic.

But it's encrypted. Fortunately, you also intercepted the key exchange and
figured out what software he was using.....

a = 1757701996813509289191531724603608357806387521749130701110232132281571970960
57417384591915694975480999440257710025303691337166219429638532300821869439381645
91230020725702755002287589522851172217336150522367152517270250629688405924844750
02615554719902078020299620055542665219063183728829999908333564992370817585959475
02374486405132806838592963676075235422935385552152827981004551102665658815998291
07971869244773384413618546118850868579583095489023778055976570366853411496753062
21622929371055768621231430084812161455880632878857809614457660524897191645478361
5989429937555579437307320472405217413938048149254574677430624
b = 1522862831855807172824546280236623684837541610282023982535032924714890018264
72439949045197875281428243538370701947855508989620972193093448811839489148503543
40893035399529028331238911753358245357848436203268982345430735846016484221944423
49995695840618985496933030512547906587371233126987013502816201808745146065620308
58249631233107579853627486542045951365941846368626935635107670258002528227761549
86386637346156842972134635578534633722315375292616298410141343725683471387328655
10692031023600703495100432972071753366605262554076091136082354831881016136791328
1234234193760867208897459774865037319252137821553407707977377
message = jqMYIn4fzSqzIXArwJm/kPitNhf4lwhL0yPRKpF+NYXyPmhoEwNG/k2L5vCZqFWNPvTzis
nu93/8uK/PZnnCGg==
```

# Analysis

The message seems to be Base64 encoded. But since the message is encrypted this
doesn't help us yet.

- Given are two very large numbers: a and b.
- Guess: They're from a Diffie-Hellman key exchange.
- Problem: We don't have the public base g and modulus p.

But the text says that we've intercepted the key exchange -> it can't be
Diffie-Hellman because a and b are secret and won't be transmitted.

Conclusion: Doesn't seem solvable...

Somehow managed to miss FasterKeyExchange.py :o

Provides g and p.

```
g = 3
p = 0x00e1a540d72bb311db26ea6e58b7dc207cf55d0c3a90d7c1f74e7fcb67c7af097d99c73e00
2c9266e70cbdf735ebd864ea279a0a4d41dd6537837bfc07d84943a376d163ec20a51dd6073dbfc3
4cbdce9d88ad22a9bb72f5bb143b5c9e531ab100590b9f97d1e9c7a3dfe7961fd6e86078ad43918b
47816925803db47862e5f69c90078c6dc287fc6cf7742a9f1717d828a610fe469c92f34783351b21
ac1ec988eae0e16ff4ef89c1a19ccd7e3b5cb0c14e0424dfde338789923013aeb7791e19ba378cb2
e0e0b318f46865d438ac53999f69f0ae8045d2ff40821b5fdcb0a3b9942f29a0cd8e55febd0ee900
6d936d51335a2e63b6affbed6175e1228a53d6a9
```
<!--  = 28485108048483664993555355548035280166222198895946001666176121626771296893249218737525397077847205668764480554612368693880365185901557208043000358783461327101490457849680507507328413906935238470600946894126028970738464658429417189298670225371208820807229458233765994963670464288033097820224657998869577152100773636751931664064681999115918785970221555076712326560102320184503893421537140609300213936571475982401475428083617012249514547394698764059628437049495276392667030591072895287238072475746662904967506303623654151867511895994963725102852006831097845186247182085468334772849374015522514204172587601623615066592937 -->

The server also seems to have an AES key and IV.
Looking at the implementation it definitely isn't Diffie-Hellman.

a and b are the values for y form the client and server (need to find out if a
or b is the server).
We need to find x (from a PRNG) to reverse the encryption.

- What we know: g,p,y
- What we need: x
- Equation: y = (g*x) % p
  - Find x: 0 = (g*x-y) % p

Use
[https://www.alpertron.com.ar/QUADMOD.HTM](https://www.alpertron.com.ar/QUADMOD.HTM)
(very helpful!).

### $y=a$

[https://www.alpertron.com.ar/QUADMOD.HTM](https://www.alpertron.com.ar/QUADMOD.HTM):

- $a=0$
- $b=g$
- $c=-y=-a$
- $n=p$

Solution:

x = 1535404267220625262849022426469045458142869137114576955909281431652900553428
49868253281962157815845895695021085382996876713606026148403537576941819091331638
97573492858461087503205334476595470229312365805497727162669571762705941038047806
75050891867327600322040998885013010755163995679537340791377817316695342554441050
07230375683984265999260274459430262063352883717725343275347828439345688303000143
48181115075724953280567387710366794375659264751027802164342021881082026175781378
37050551059434447762507308945147507940431939876682469703610056936699291585087626
7412204007674638070052231495975910539370211916959396581341187

### $y=b$

[https://www.alpertron.com.ar/QUADMOD.HTM](https://www.alpertron.com.ar/QUADMOD.HTM):

- $a=0$
- $b=g$
- $c=-y=-b$
- $n=p$

Solution:

x = 2406628147184180057178539129947893239360660463157074771923419083356383132304
85604899851046477408513872942660598065076462198974896741412536557282221605910028
47957983699630014448631913189076240766350109997173680095635888387625106200180587
98356645868260143796193261237180213560076279915517019478138658574725188740115886
32294304175582520724001068648825684300062792523557779775061846229581780137921942
86509863103653264609433956534344554272368257606911851761413444759489601816170266
96583159546031950942560475491110826032478545352151763376275791800760794118786788
4576199454899178918198735935303355242532437674933545947054417

## Decryption

Now we should have everything we need. The last step is to write a program for
decryption and figure out if the server is a or b. I've tried it with both and
it turns out that it works in both cases. I didn't expect that (didn't think
much about it) but this is obviously expected as the server and client share the
same secret... After all the purpose of a key exchange algorithm is to secretly
share a key for a symmetric cypher.

In any case: It worked :)

The solution is in solution.py:

```
$ ./solution.py
b'Congrats! Now take the flag: HV18-DfHe-KE1s-w44y-b3tt-3r!!\x06\x06\x06\x06\x06\x06'
b'Congrats! Now take the flag: HV18-DfHe-KE1s-w44y-b3tt-3r!!\x06\x06\x06\x06\x06\x06'
```

Flag: `HV18-DfHe-KE1s-w44y-b3tt-3r!!`
